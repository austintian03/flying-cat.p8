pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
function _init()
	make_player()
	make_stars()
	make_enemies()
end

function _update()
	--add and move stars
	add_stars()
	foreach(stars,update_star)
	
	--player update
	move_player()
	player_shoot()
	if(#p.bullets>0) then
		foreach(p.bullets,update_bullet)
	end
	
	--enemy update
	foreach(enemies,update_enemy)
end

function _draw()
	cls(0)
	--background
	foreach(stars,draw_star)
	
	--player
	draw_player()
	if(#p.bullets>0) then
		foreach(p.bullets,draw_bullet)
	end
	
	--enemies
	foreach(enemies,draw_enemy)
end
-->8
function make_player()
	dr=0.5
	p={}
	p.x=8
	p.y=60
	p.dx=0
	p.dy=0
	p.max_spd=3
	p.sprite=1
	p.bullets={}
end

function move_player()
	--add drag to player movement
	if (p.dx>0) p.dx-=dr
	if (p.dx<0)	p.dx+=dr
	if (p.dy>0)	p.dy-=dr
	if (p.dy<0)	p.dy+=dr
	
	--add speed
	if (btn(0)) p.dx-=1
	if (btn(1)) p.dx+=1
	if (btn(2)) p.dy-=1
	if (btn(3)) p.dy+=1
	cap_speed()
	
	--adjust position
	p.x+=p.dx
	p.y+=p.dy
	stay_on_screen()
end

function stay_on_screen()
	if (p.x<0) then --left side
		p.x=0
		p.dx=0
	end
	if (p.x>111) then --right side
		p.x=111
		p.dx=0
	end
	if (p.y<0) then --top side
		p.y=0
		p.dy=0
	end
	if (p.y>111) then --bot side
		p.y=111
		p.dy=0
	end
end

function cap_speed()
	--cap horizontal speed
	local cap_dx=mid(0,abs(p.dx),p.max_spd)
	p.dx=(p.dx/abs(p.dx)) * cap_dx
	
	--cap vertical speed
	local cap_dy=mid(0,abs(p.dy),p.max_spd)
	p.dy=(p.dy/abs(p.dy)) * cap_dy
end

function player_shoot()
	if(btnp(5)) then
		sfx(0)
		local b={}
		b.x=p.x+15
		b.y=p.y+11
		add(p.bullets,b)
	end
end

function update_bullet(b)
	b.x+=3
	if(b.x>127) then
		del(p.bullets,b)
	end
end

function draw_bullet(b)
	pset(b.x,b.y,8)
end

function draw_player()
	spr(p.sprite,p.x,p.y,2,2)
end
-->8
function rndb(low,high)
	return flr(rnd(high-low+1)+low)
end

function rndbf(low,high)
	return rnd(high-low+1)+low
end

function make_stars()
 stars={}
 for i=1,25 do
 	local s={}
 	s.x=rndb(0,127)
 	s.y=rndb(0,127)
 	s.col=rndb(5,7)
		add(stars,s)
	end
end

function update_star(s)
	s.x-=1
	if (s.x<0) del(stars,s)
end

function add_stars()
	while (#stars<50) do
		local s={}
		s.x=rndb(128,255)
		s.y=rndb(0,127)
		s.col=rndb(5,7)
		add(stars,s)
	end
end

function draw_star(s)
	pset(s.x,s.y,s.col)
end
-->8
function make_enemies()
	enemies={}
	for i=1,10 do
		local e={}
		e.x=rndb(176,512)
		e.y=rndb(0,119)
		e.dx=0
		e.dy=0
		e.sprite={4,5}
		e.nf=rndb(1,2)
		e.ft=rndb(15,20)
		e.aggro=false
		add(enemies,e)
	end
end

function update_enemy(e)
	local dist={e.x-p.x,p.y-e.y}	--line between player and enemy
 local rf=mid(0.5,1,atan2(dist[1],abs(dist[2])))
	local dir=dist[2]/abs(dist[2])
	--move toward player location
	if (e.x<p.x+71 and e.x>=p.x-128) then
		e.aggro=true
		e.dy=dir*rf
		e.dx=2.5*rf
	else
		e.aggro=false
		e.dx=0.8*rf
		e.dy=rndb(-1,1)*rf
	end
	
	bind_vertical(e)
	e.x-=e.dx
	e.y+=e.dy
	
	if (e.x<-7) del(enemies,e)
end

function bind_vertical(e)
	--prevent collision with other bats
	if (pget(e.x,e.y-1)==3 or
	pget(e.x,e.y+8)==3) then
		e.dy=0
	end
	
	if (e.y<=0) then --top side
		e.y=0
	end
	if (e.y>=119) then --bot side
		e.y=119
	end
end

function draw_enemy(e)
	--frametime calc
	e.ft-=1
	if (e.ft==0) then
		if (e.nf==1) then
			e.nf=2
		elseif (e.nf==2) then
			e.nf=1
		end
		if (not e.aggro) then
			e.ft=15
		else
			e.ft=5
		end
	end
	
	--draw sprite
	spr(e.sprite[e.nf],e.x,e.y)
end
__gfx__
00000000000000000000000000555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000555555000200d0060200d0620200d02005005000000000000000000000000000000000000000000000000000000000000000000
00700700000000003000000005d55d500002d0002202d0222202d022000550000000000000000000000000000000000000000000000000000000000000000000
00077000000000030000000055dddd5500828200228282222282822200d5d5000000000000000000000000000000000000000000000000000000000000000000
0007700000000004400000000daddad002222d2022222d2202222d20055555500000000000000000000000000000000000000000000000000000000000000000
007007000000005555000000d0dddd002d02d0222002d0020002d000550550550000000000000000000000000000000000000000000000000000000000000000
0000000000000555555000000d0dd000200000020000000000200200005005000000000000000000000000000000000000000000000000000000000000000000
00000000000005d55d50000000ddd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000055dddd55000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000daddad0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000009000d0dddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000009900d0dd006665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000900900ddd005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000099094444444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000009900000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000003000000000000000330000000000000033000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000030800000000000003003800000000000300380000000000000000000000000000000000000000000000000000000000000
000000000000000030000000000000300000000000000030088000000000003008f8000000000000000000000000000000000000000000000000000000000000
00000000000000030000000000000003000000000000080300000000000008030080000000000000000000000000000000000000000000000000000000000000
00000000000000044000000000000004400000000000000440000000000000044000800000000000000000000000000000000000000000000000000000000000
00000000000000555500000000000055550000000000005555000000000000555500000000000000000000000000000000000000000000000000000000000000
00000000000005555550000000000555555000000000055555500000000005555550000000000000000000000000000000000000000000000000000000000000
00000000000005d55d500000000005d55d500000000005d55d500000000005d55d50000000000000000000000000000000000000000000000000000000000000
00000000000055dddd550000000055dddd550000000055dddd550000000055dddd55000000000000000000000000000000000000000000000000000000000000
0000000000000daddad0000000000daddad0000000000daddad0000000000daddad0000000000000000000000000000000000000000000000000000000000000
000000009000d0dddd0000009000d0dddd0000009000d0dddd0000009000d0dddd00000000000000000000000000000000000000000000000000000000000000
0000000009900d0dd006665009900d0dd006665009900d0dd006665009900d0dd006665000000000000000000000000000000000000000000000000000000000
00000000900900ddd0050000900900ddd0050000900900ddd0050000900900ddd005000000000000000000000000000000000000000000000000000000000000
00000000099094444444444009909444444444400990944444444440099094444444444000000000000000000000000000000000000000000000000000000000
00000000009900000000000400990000000000040099000000000004009900000000000400000000000000000000000000000000000000000000000000000000
00000000990000000000000099000000000000009900000000000000990000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000001010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
00010000000000500001600016000160001600026000070000000066000660007600057000670007700087000b700096000000000000000000000000000000000000000000114000e400134101e4101d41022410
